version: '3.8'

services:
  # ===============================================================================
  # INFRAESTRUCTURA - BASES DE DATOS MYSQL
  # ===============================================================================
  
  # MySQL para Auth Service
  mysql_auth:
    image: mysql:8.0
    container_name: pontificia_mysql_auth
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: auth_db
      MYSQL_USER: auth_user
      MYSQL_PASSWORD: auth_password_123
    ports:
      - "3307:3306"
    volumes:
      - mysql_auth_data:/var/lib/mysql
    networks:
      - pontificia_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MySQL para Users Service
  mysql_users:
    image: mysql:8.0
    container_name: pontificia_mysql_users
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: users_db
      MYSQL_USER: users_user
      MYSQL_PASSWORD: users_password_123
    ports:
      - "3308:3306"
    volumes:
      - mysql_users_data:/var/lib/mysql
    networks:
      - pontificia_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MySQL para Asistencia Service
  mysql_asistencia:
    image: mysql:8.0
    container_name: pontificia_mysql_asistencia
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: asistencia_db
      MYSQL_USER: asistencia_user
      MYSQL_PASSWORD: asistencia_password_123
    ports:
      - "3309:3306"
    volumes:
      - mysql_asistencia_data:/var/lib/mysql
    networks:
      - pontificia_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MySQL para Documentos Service
  mysql_documentos:
    image: mysql:8.0
    container_name: pontificia_mysql_documentos
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: documentos_db
      MYSQL_USER: documentos_user
      MYSQL_PASSWORD: documentos_password_123
    ports:
      - "3310:3306"
    volumes:
      - mysql_documentos_data:/var/lib/mysql
    networks:
      - pontificia_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MySQL para Pagos Service
  mysql_pagos:
    image: mysql:8.0
    container_name: pontificia_mysql_pagos
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: pagos_db
      MYSQL_USER: pagos_user
      MYSQL_PASSWORD: pagos_password_123
    ports:
      - "3311:3306"
    volumes:
      - mysql_pagos_data:/var/lib/mysql
    networks:
      - pontificia_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MySQL para Reportes Service
  mysql_reportes:
    image: mysql:8.0
    container_name: pontificia_mysql_reportes
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: reportes_db
      MYSQL_USER: reportes_user
      MYSQL_PASSWORD: reportes_password_123
    ports:
      - "3312:3306"
    volumes:
      - mysql_reportes_data:/var/lib/mysql
    networks:
      - pontificia_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MySQL para Auditoria Service
  mysql_auditoria:
    image: mysql:8.0
    container_name: pontificia_mysql_auditoria
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: auditoria_db
      MYSQL_USER: auditoria_user
      MYSQL_PASSWORD: auditoria_password_123
    ports:
      - "3313:3306"
    volumes:
      - mysql_auditoria_data:/var/lib/mysql
    networks:
      - pontificia_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Redis para cache y Celery
  redis:
    image: redis:7-alpine
    container_name: pontificia_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - pontificia_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===============================================================================
  # API GATEWAY - PUNTO DE ENTRADA PRINCIPAL
  # ===============================================================================
  
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: pontificia_gateway
    ports:
      - "8000:8000"
    environment:
      - DEBUG=True
      - DJANGO_SECRET_KEY=gateway-secret-key-for-docker
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,gateway
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=sqlite:///db.sqlite3
      # URLs de microservicios
      - AUTH_SERVICE_URL=http://auth-service:3001
      - USERS_SERVICE_URL=http://users-service:3002
      - ATTENDANCE_SERVICE_URL=http://attendance-service:3003
      - PAYMENTS_SERVICE_URL=http://payments-service:3004
      - DOCUMENTS_SERVICE_URL=http://documents-service:3005
      - REPORTS_SERVICE_URL=http://reports-service:3006
      - AUDIT_SERVICE_URL=http://audit-service:3007
      # Gateway config
      - GATEWAY_ENABLE_PROXY=True
      - GATEWAY_ENABLE_JWT_VALIDATION=True
      - GATEWAY_ENABLE_RATE_LIMITING=True
      - CORS_ALLOW_ALL_ORIGINS=True
    volumes:
      - ./gateway:/app
      - gateway_logs:/app/logs
    networks:
      - pontificia_network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ===============================================================================
  # MICROSERVICIOS
  # ===============================================================================

  # Servicio de Autenticación
  auth-service:
    build:
      context: ./auth
      dockerfile: Dockerfile
    container_name: pontificia_auth
    ports:
      - "3001:8000"
    environment:
      - DEBUG=True
      - DATABASE_URL=mysql://auth_user:auth_password_123@mysql_auth:3306/auth_db
      - REDIS_URL=redis://redis:6379/1
      - DJANGO_SECRET_KEY=auth-service-secret-key-for-docker
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,auth-service
    networks:
      - pontificia_network
    depends_on:
      mysql_auth:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Servicio de Usuarios
  users-service:
    build:
      context: ./users
      dockerfile: Dockerfile
    container_name: pontificia_users
    ports:
      - "3002:8000"
    environment:
      - DEBUG=True
      - DATABASE_URL=mysql://users_user:users_password_123@mysql_users:3306/users_db
      - AUTH_SERVICE_URL=http://auth-service:3001
      - DJANGO_SECRET_KEY=users-service-secret-key-for-docker
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,users-service
    networks:
      - pontificia_network
    depends_on:
      mysql_users:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Servicio de Asistencias
  attendance-service:
    build:
      context: ./asistencia
      dockerfile: Dockerfile
    container_name: pontificia_attendance
    ports:
      - "3003:3003"
    environment:
      - DEBUG=True
      - DJANGO_SECRET_KEY=attendance-secret-key-for-docker
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,attendance-service
      - DATABASE_URL=mysql://asistencia_user:asistencia_password_123@mysql_asistencia:3306/asistencia_db
      - AUTH_SERVICE_URL=http://auth-service:3001
      - USERS_SERVICE_URL=http://users-service:3002
    volumes:
      - ./asistencia:/app
      - attendance_data:/app/data
    networks:
      - pontificia_network
    depends_on:
      mysql_asistencia:
        condition: service_healthy
      auth-service:
        condition: service_started
      users-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Servicio de Pagos
  payments-service:
    build:
      context: ./pagos
      dockerfile: Dockerfile
    container_name: pontificia_payments
    ports:
      - "3004:3004"
    environment:
      - DEBUG=True
      - DJANGO_SECRET_KEY=payments-secret-key-for-docker
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,payments-service
      - DATABASE_URL=mysql://pagos_user:pagos_password_123@mysql_pagos:3306/pagos_db
      - AUTH_SERVICE_URL=http://auth-service:3001
      - USERS_SERVICE_URL=http://users-service:3002
    volumes:
      - ./pagos:/app
      - payments_data:/app/data
    networks:
      - pontificia_network
    depends_on:
      mysql_pagos:
        condition: service_healthy
      auth-service:
        condition: service_started
      users-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Servicio de Documentos
  documents-service:
    build:
      context: ./documentos
      dockerfile: Dockerfile
    container_name: pontificia_documents
    ports:
      - "3005:3005"
    environment:
      - DEBUG=True
      - DJANGO_SECRET_KEY=documents-secret-key-for-docker
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,documents-service
      - DATABASE_URL=mysql://documentos_user:documentos_password_123@mysql_documentos:3306/documentos_db
      - AUTH_SERVICE_URL=http://auth-service:3001
      - USERS_SERVICE_URL=http://users-service:3002
    volumes:
      - ./documentos:/app
      - documents_data:/app/data
      - documents_files:/app/media
    networks:
      - pontificia_network
    depends_on:
      mysql_documentos:
        condition: service_healthy
      auth-service:
        condition: service_started
      users-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Servicio de Reportes
  reports-service:
    build:
      context: ./reportes
      dockerfile: Dockerfile
    container_name: pontificia_reports
    ports:
      - "3006:3006"
    environment:
      - DEBUG=True
      - DJANGO_SECRET_KEY=reports-secret-key-for-docker
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,reports-service
      - DATABASE_URL=mysql://reportes_user:reportes_password_123@mysql_reportes:3306/reportes_db
      - AUTH_SERVICE_URL=http://auth-service:3001
      - USERS_SERVICE_URL=http://users-service:3002
      - ATTENDANCE_SERVICE_URL=http://attendance-service:3003
      - PAYMENTS_SERVICE_URL=http://payments-service:3004
    volumes:
      - ./reportes:/app
      - reports_data:/app/data
    networks:
      - pontificia_network
    depends_on:
      mysql_reportes:
        condition: service_healthy
      auth-service:
        condition: service_started
      users-service:
        condition: service_started
      attendance-service:
        condition: service_started
      payments-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3006/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Servicio de Auditoría
  audit-service:
    build:
      context: ./auditoria
      dockerfile: Dockerfile
    container_name: pontificia_audit
    ports:
      - "3007:3007"
    environment:
      - DEBUG=True
      - DJANGO_SECRET_KEY=audit-secret-key-for-docker
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,audit-service
      - DATABASE_URL=mysql://auditoria_user:auditoria_password_123@mysql_auditoria:3306/auditoria_db
      - AUTH_SERVICE_URL=http://auth-service:3001
      - USERS_SERVICE_URL=http://users-service:3002
    volumes:
      - ./auditoria:/app
      - audit_data:/app/data
      - audit_logs:/app/logs
    networks:
      - pontificia_network
    depends_on:
      mysql_auditoria:
        condition: service_healthy
      auth-service:
        condition: service_started
      users-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3007/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ===============================================================================
  # UTILIDADES DE DESARROLLO
  # ===============================================================================
  
  # Nginx para producción (opcional)
  nginx:
    image: nginx:alpine
    container_name: pontificia_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
      - nginx_logs:/var/log/nginx
    networks:
      - pontificia_network
    depends_on:
      - gateway
    restart: unless-stopped
    profiles:
      - production

  # Adminer para gestión de base de datos MySQL
  adminer:
    image: adminer
    container_name: pontificia_adminer
    ports:
      - "8080:8080"
    networks:
      - pontificia_network
    depends_on:
      - mysql_auth
      - mysql_users
      - mysql_asistencia
      - mysql_documentos
      - mysql_pagos
      - mysql_reportes
      - mysql_auditoria
    restart: unless-stopped
    profiles:
      - development

# ===============================================================================
# REDES Y VOLÚMENES
# ===============================================================================

networks:
  pontificia_network:
    driver: bridge
    name: pontificia_network

volumes:
  # Infraestructura
  redis_data:
    name: pontificia_redis_data
  nginx_logs:
    name: pontificia_nginx_logs
  
  # MySQL data volumes
  mysql_auth_data:
    name: pontificia_mysql_auth_data
  mysql_users_data:
    name: pontificia_mysql_users_data
  mysql_asistencia_data:
    name: pontificia_mysql_asistencia_data
  mysql_documentos_data:
    name: pontificia_mysql_documentos_data
  mysql_pagos_data:
    name: pontificia_mysql_pagos_data
  mysql_reportes_data:
    name: pontificia_mysql_reportes_data
  mysql_auditoria_data:
    name: pontificia_mysql_auditoria_data
  
  # Gateway
  gateway_logs:
    name: pontificia_gateway_logs
  
  # Microservicios data
  auth_data:
    name: pontificia_auth_data
  users_data:
    name: pontificia_users_data
  attendance_data:
    name: pontificia_attendance_data
  payments_data:
    name: pontificia_payments_data
  documents_data:
    name: pontificia_documents_data
  documents_files:
    name: pontificia_documents_files
  reports_data:
    name: pontificia_reports_data
  audit_data:
    name: pontificia_audit_data
  audit_logs:
    name: pontificia_audit_logs